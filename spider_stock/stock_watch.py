#coding=utf-8'''获取每天个股的数据(部分股票)'''import syssys.path.append('..')import urllib.requestimport jsonfrom mysql.MysqlHelper import MysqlHelperfrom datetime import datetimefrom spider_stock.StockHelper import StockHelperimport timefrom mysql.proxy_api import proxy_listimport socketimport random#构建2个代理ipstock_helper = StockHelper()today = datetime.now().strftime('%Y-%m-%d')sql = "select * from tan_stock where is_big=1"all_report = stock_helper.getWatchStock()#准备一个需要的ipfor one in all_report:    #获取60个可用ip    sid = one[1]    link = 'http://d.10jqka.com.cn/v6/time/hs_%s/last.js'%(sid)    money_link = 'http://d.10jqka.com.cn/v2/moneyflow/hs_%s/last.js'%(sid)    referer = 'http://stockpage.10jqka.com.cn/HQ_v4.html'    key = 'hs_%s'%(sid)    #主要获取股票价格，是否涨停    content = stock_helper.getStockPrciePoints(link)    #content = 'quotebridge_v6_time_hs_002458_last({"hs_002458":{"name":"\u76ca\u751f\u80a1\u4efd","open":1,"stop":0,"rt":"0930-1130,1300-1500","tradeTime":["0930-1130","1300-1500"],"pre":"18.34","date":"20180906","data":"0930,18.08,193456,18.080,10700;0931,18.05,1254189,18.073,69400;0932,18.10,984143,18.080,54400;0933,18.05,712776,18.080,39430;0934,18.01,4265357,18.045,236700;0935,18.10,576934,18.046,31962;0936,18.26,1392887,18.063,76700;0937,18.17,942613,18.072,51900;0938,18.18,1028023,18.080,56600;0939,18.16,686408,18.084,37800;0940,18.13,723254,18.087,39900;0941,18.27,1186126,18.096,65200;0942,18.23,716497,18.102,39300;0943,18.43,1315716,18.120,71800;0944,18.28,151970,18.122,8300;0945,18.23,155158,18.123,8500;0946,18.25,347229,18.127,19000;0947,18.18,719701,18.130,39500;0948,18.13,411857,18.131,22700;0949,18.12,1040332,18.129,57500;0950,18.06,376129,18.128,20800;0951,18.10,186288,18.127,10300;0952,18.14,516494,18.127,28500;0953,18.14,47152,18.127,2600;0954,18.08,278504,18.127,15400;0955,18.08,399215,18.125,22100;0956,18.05,493324,18.124,27300;0957,18.07,639086,18.122,35400;0958,18.07,688424,18.120,38100;0959,18.10,394197,18.120,21800;1000,18.12,70734,18.120,3900;1001,18.15,373365,18.120,20600;1002,18.14,235895,18.120,13000;1003,18.11,126849,18.120,7000;1004,18.11,401912,18.120,22200;1005,18.16,460516,18.120,25400;1006,18.13,421596,18.121,23200;1007,18.20,323130,18.121,17800;1008,18.16,169159,18.122,9300;1009,18.15,286769,18.122,15800;1010,18.16,192670,18.123,10600;1011,18.13,304763,18.123,16800;1012,18.12,212021,18.123,11700;1013,18.12,219234,18.123,12100;1014,18.14,322654,18.123,17800;1015,18.10,706533,18.123,39000;1016,18.07,276759,18.122,15300;1017,18.11,271537,18.122,15000;1018,18.09,1304092,18.123,71900;1019,18.16,92479,18.123,5100;1020,18.12,48924,18.123,2700;1021,18.12,34436,18.123,1900;1022,18.08,278585,18.122,15400;1023,18.08,274895,18.122,15200;1024,18.07,186190,18.122,10300;1025,18.06,641298,18.121,35500;1026,18.04,471060,18.120,26100;1027,18.05,494376,18.118,27400;1028,18.02,813187,18.116,45100;1029,18.01,1946286,18.110,108100;1030,18.05,1222895,18.107,67900;1031,18.07,95671,18.106,5300;1032,18.07,101235,18.106,5600;1033,18.00,700738,18.105,38900;1034,18.03,378192,18.104,21000;1035,17.99,685837,18.102,38100;1036,18.01,315318,18.101,17500;1037,18.03,335221,18.100,18600;1038,18.04,254057,18.100,14100;1039,18.05,356873,18.099,19800;1040,18.02,281346,18.099,15600;1041,18.07,350076,18.098,19400;1042,18.08,325500,18.098,18000;1043,18.08,242261,18.098,13400;1044,18.10,397893,18.098,22000;1045,18.15,1094130,18.098,60400;1046,18.12,106976,18.098,5900;1047,18.12,99620,18.098,5500;1048,18.09,170271,18.098,9400;1049,18.12,141242,18.098,7800;1050,18.14,190407,18.099,10500;1051,18.18,337739,18.099,18600;1052,18.15,163236,18.099,9000;1053,18.10,486455,18.099,26900;1054,18.14,164928,18.099,9100;1055,18.13,94236,18.099,5200;1056,18.11,110438,18.099,6100;1057,18.10,168169,18.099,9300;1058,18.11,101389,18.099,5600;1059,18.11,146619,18.099,8100;1100,18.11,224174,18.099,12400;1101,18.11,92361,18.099,5100;1102,18.10,90503,18.099,5000;1103,18.09,179009,18.099,9900;1104,18.09,135601,18.099,7500;1105,18.11,334608,18.099,18500;1106,18.11,152038,18.099,8400;1107,18.11,77851,18.099,4300;1108,18.13,162951,18.099,9000;1109,18.13,85211,18.099,4700;1110,18.12,65221,18.099,3600;1111,18.13,94275,18.099,5200;1112,18.15,437306,18.100,24100;1113,18.14,404894,18.100,22300;1114,18.17,125361,18.100,6900;1115,18.14,221278,18.100,12200;1116,18.21,1181410,18.103,64900;1117,18.22,158476,18.103,8700;1118,18.18,100184,18.103,5500;1119,18.24,125789,18.104,6900;1120,18.27,805065,18.106,44100;1121,18.24,760026,18.109,41600;1122,18.19,187310,18.109,10300;1123,18.18,212723,18.109,11700;1124,18.18,9090,18.109,500;1125,18.17,23622,18.109,1300;1126,18.15,9075,18.109,500;1127,18.15,0,18.109,0;1128,18.15,12705,18.109,700;1129,18.20,225456,18.110,12400;1130,18.17,18163,18.110,1000;1300,18.20,1113433,18.113,61000;1301,18.20,1113433,18.113,61000;1302,18.26,103992,18.113,5700;1303,18.22,18220,18.113,1000;1304,18.22,41864,18.113,2300;1305,18.20,140014,18.113,7700;1306,18.17,50885,18.113,2800;1307,18.16,21795,18.113,1200;1308,18.15,85333,18.113,4700;1309,18.14,27210,18.113,1500;1310,18.11,606809,18.113,33500;1311,18.10,3283323,18.113,181300;1312,18.10,238927,18.113,13200;1313,18.10,52487,18.113,2900;1314,18.08,101270,18.113,5600;1315,18.08,200598,18.113,11100;1316,18.08,7232,18.113,400;1317,18.07,357693,18.113,19800;1318,18.06,68653,18.113,3800;1319,18.05,120945,18.112,6700;1320,18.05,420435,18.112,23300;1321,18.07,557727,18.111,30900;1322,18.09,16277,18.111,900;1323,18.08,103111,18.111,5700;1324,18.08,59668,18.111,3300;1325,18.11,244093,18.111,13500;1326,18.12,204603,18.111,11300;1327,18.14,19944,18.111,1100;1328,18.16,181518,18.111,10000;1329,18.24,600409,18.112,33000;1330,18.23,196916,18.113,10800;1331,18.17,43618,18.113,2400;1332,18.17,18160,18.113,1000;1333,18.16,25433,18.113,1400;1334,18.14,48999,18.113,2700;1335,18.15,123407,18.113,6800;1336,18.15,152571,18.113,8400;1337,18.12,203174,18.113,11200;1338,18.13,9070,18.113,500;1339,18.13,29008,18.113,1600;1340,18.15,45359,18.113,2500;1341,18.16,58082,18.113,3200;1342,18.13,114339,18.113,6300;1343,18.13,72520,18.113,4000;1344,18.18,61780,18.113,3400;1345,18.17,70865,18.113,3900;1346,18.11,302606,18.113,16700;1347,18.10,249895,18.113,13800;1348,18.12,646541,18.113,35700;1349,18.10,164775,18.113,9100;1350,18.08,326141,18.113,18000;1351,18.10,34381,18.113,1900;1352,18.08,276695,18.113,15300;1353,18.06,699203,18.113,38700;1354,18.05,281392,18.112,15600;1355,18.04,55902,18.112,3100;1356,18.09,1809,18.112,100;1357,18.09,63246,18.112,3500;1358,18.07,119276,18.112,6600;1359,18.10,218879,18.112,12100;1400,18.08,21706,18.112,1200;1401,18.08,151896,18.112,8400;1402,18.04,218404,18.112,12100;1403,18.04,144277,18.112,8000;1404,18.02,218154,18.111,12100;1405,17.98,9239888,18.097,513400;1406,18.01,444397,18.096,24700;1407,17.98,813362,18.095,45200;1408,17.93,866992,18.094,48300;1409,17.92,476961,18.093,26600;1410,17.91,649956,18.091,36300;1411,17.90,463785,18.090,25900;1412,17.90,195130,18.090,10900;1413,17.93,283063,18.089,15800;1414,17.87,771253,18.087,43100;1415,17.88,372055,18.086,20800;1416,17.86,941715,18.084,52700;1417,17.83,950843,18.081,53300;1418,17.76,2246796,18.073,126200;1419,17.77,1592388,18.067,89700;1420,17.75,946113,18.063,53400;1421,17.84,457816,18.062,25700;1422,17.73,933868,18.059,52400;1423,17.76,211146,18.059,11900;1424,17.80,261205,18.058,14700;1425,17.87,648202,18.056,36400;1426,17.98,336708,18.055,18800;1427,17.93,375320,18.055,20900;1428,17.87,96556,18.055,5400;1429,17.96,197314,18.055,11000;1430,17.94,175947,18.054,9800;1431,17.98,364369,18.054,20300;1432,18.03,617821,18.054,34300;1433,18.04,223855,18.054,12400;1434,18.06,570334,18.054,31600;1435,18.06,606700,18.054,33600;1436,18.06,518611,18.054,28700;1437,18.05,426001,18.054,23600;1438,18.01,755457,18.053,41900;1439,18.00,646697,18.053,35900;1440,17.98,386806,18.053,21500;1441,17.91,541856,18.052,30200;1442,17.96,258070,18.052,14400;1443,17.96,102439,18.052,5700;1444,18.00,438723,18.052,24400;1445,17.98,219487,18.051,12200;1446,17.99,345162,18.051,19200;1447,17.94,448832,18.051,25000;1448,17.98,527580,18.050,29385;1449,18.00,600998,18.050,33400;1450,18.02,836156,18.050,46400;1451,18.05,727008,18.050,40300;1452,18.08,717310,18.050,39700;1453,18.10,1057977,18.050,58500;1454,18.20,1529017,18.052,84100;1455,18.10,1791827,18.055,98300;1456,18.17,583052,18.056,32100;1457,18.10,982830,18.056,54200;1458,18.10,5430,18.056,300;1459,18.10,0,18.056,0;1500,18.25,4692075,18.064,257100","dotsCount":242,"dates":["20180906"]}})'    print(content)    if content is None:        time.sleep(random.uniform(62, 65))        continue    arr = content.split('last(')    json_content = arr[1].strip(')')    json_content = json.loads(json_content)    print(json_content)    exit()    all = json_content[key]    is_stop = all['stop']    is_open = all['open']    #不开市    #iif is_open == 0:       # break    #停牌    if is_stop == 1 :        time.sleep(random.uniform(62, 65))        continue    pre = float(all['pre'])#昨收    data_arr = all['data'].split(';')    name = all['name']    time.sleep(random.uniform(62, 65))    #获取大中小单    content = stock_helper.getStockMoneyPoints(money_link)    #content = 'quotebridge_v2_moneyflow_hs_002458_last({"hs_002458":{"name":"\u76ca\u751f\u80a1\u4efd","open":1,"rt":"0930-1130,1300-1500","date":"20180906","tradeTime":["0930-1130","1300-1500"],"data":"0930,-0.00,-0.00,-0.00,-0.00,74128.00,115712.00,-0.00,-0.00;0931,-0.00,-0.00,361477.00,-0.00,345143.00,260234.00,-0.00,287311.00;0932,-0.00,-0.00,361477.00,241888.00,442915.00,560626.00,255285.00,565977.00;0933,-0.00,-0.00,361477.00,241888.00,508056.00,1049164.00,255285.00,726889.00;0934,1180033.00,-0.00,361477.00,506635.00,796172.00,1956821.00,783060.00,1823922.00;0935,1180033.00,-0.00,361477.00,506635.00,1072509.14,2102271.00,835550.00,1928380.00;0936,1180033.00,-0.00,725035.00,506635.00,1157891.14,2374435.00,1258532.00,2166225.00;0937,1180033.00,726189.00,725035.00,506635.00,1214281.14,2487078.00,1315062.00,2166225.00;0938,1180033.00,726189.00,725035.00,506635.00,1437774.10,2670505.00,1391418.00,2649165.00;0939,1180033.00,726189.00,725035.00,506635.00,1677624.10,2931927.00,1514937.00,2763510.00;0940,1180033.00,726189.00,725035.00,506635.00,1828163.10,3191072.00,1514937.00,3062594.00;0941,1180033.00,726189.00,725035.00,843205.00,1955283.10,3468894.00,1724614.00,3313779.00;0942,1180033.00,726189.00,725035.00,843205.00,2079389.10,3714975.00,1724614.00,3630941.00;0943,1180033.00,726189.00,933616.00,843205.00,2480948.10,3964137.00,2021347.00,3828905.00;0944,1180033.00,726189.00,933616.00,843205.00,2519434.10,4070307.00,2021347.00,3828905.00;0945,1180033.00,726189.00,933616.00,843205.00,2574238.10,4170683.00,2021347.00,3828905.00;0946,1180033.00,726189.00,933616.00,843205.00,2751563.10,4240012.00,2072699.00,3883595.00;0947,1180033.00,726189.00,933616.00,1076549.00,2804513.10,4456780.00,2072699.00,4065699.00;0948,1180033.00,726189.00,933616.00,1076549.00,2820851.10,4582068.00,2072699.00,4354166.00;0949,1180033.00,1313789.00,933616.00,1076549.00,2983899.10,4665349.00,2072699.00,4576881.00;0950,1180033.00,1313789.00,933616.00,1076549.00,3032738.10,4773820.00,2072699.00,4790288.00;0951,1180033.00,1313789.00,933616.00,1076549.00,3105087.10,4829823.00,2137859.00,4790288.00;0952,1180033.00,1313789.00,933616.00,1076549.00,3248334.10,4905982.00,2137859.00,5083748.00;0953,1180033.00,1313789.00,933616.00,1076549.00,3273730.10,4922296.00,2137859.00,5083748.00;0954,1180033.00,1313789.00,933616.00,1076549.00,3318982.10,5099530.00,2137859.00,5147028.00;0955,1180033.00,1313789.00,1181098.00,1076549.00,3351514.10,5215114.00,2137859.00,5147028.00;0956,1180033.00,1313789.00,1181098.00,1076549.00,3405750.10,5361564.00,2137859.00,5336734.00;0957,1180033.00,1313789.00,1181098.00,1076549.00,3454519.10,5511484.00,2199253.00,5813252.00;0958,1180033.00,1313789.00,1181098.00,1076549.00,3534023.10,5632514.00,2446812.00,6062618.00;0959,1180033.00,1313789.00,1181098.00,1076549.00,3711262.10,5760779.00,2446812.00,6062618.00;1000,1180033.00,1313789.00,1181098.00,1076549.00,3769310.10,5768029.00,2446812.00,6153118.00;1001,1180033.00,1313789.00,1181098.00,1076549.00,3807385.10,5800645.00,2555554.00,6348856.00;1002,1180033.00,1313789.00,1181098.00,1076549.00,3907185.10,5849620.00,2646304.00,6348856.00;1003,1180033.00,1313789.00,1181098.00,1076549.00,3948890.10,5934764.00,2646304.00,6348856.00;1004,1180033.00,1313789.00,1181098.00,1311885.00,4012256.10,6036163.00,2646304.00,6348856.00;1005,1180033.00,1313789.00,1181098.00,1311885.00,4077492.10,6137586.00,2882204.00,6406808.00;1006,1180033.00,1313789.00,1408410.00,1311885.00,4117462.10,6177552.00,2882204.00,6486712.00;1007,1180033.00,1313789.00,1408410.00,1311885.00,4206422.10,6250078.00,2973076.00,6591924.00;1008,1180033.00,1313789.00,1408410.00,1311885.00,4259178.10,6251896.00,3080401.00,6591924.00;1009,1180033.00,1313789.00,1408410.00,1311885.00,4288218.10,6384395.00,3080401.00,6724419.00;1010,1180033.00,1313789.00,1408410.00,1311885.00,4317274.10,6402547.00,3225862.00,6724419.00;1011,1180033.00,1313789.00,1408410.00,1311885.00,4378977.10,6467869.00,3225862.00,6813305.00;1012,1180033.00,1313789.00,1408410.00,1311885.00,4406157.10,6507729.00,3225862.00,7041706.00;1013,1180033.00,1313789.00,1408410.00,1311885.00,4427909.10,6643629.00,3225862.00,7092416.00;1014,1180033.00,1313789.00,1408410.00,1311885.00,4438787.10,6707054.00,3336455.00,7233782.00;1015,1180033.00,1313789.00,1408410.00,1630639.00,4500448.10,6868245.00,3336455.00,7384261.00;1016,1180033.00,1313789.00,1408410.00,1630639.00,4534856.10,7009368.00,3336455.00,7510835.00;1017,1180033.00,1313789.00,1408410.00,1630639.00,4571065.10,7116107.00,3336455.00,7633983.00;1018,1724135.00,1313789.00,1816763.00,1630639.00,4590981.10,7206611.00,3336455.00,7875210.00;1019,1724135.00,1313789.00,1816763.00,1630639.00,4643620.10,7250048.00,3336455.00,7875210.00;1020,1724135.00,1313789.00,1816763.00,1630639.00,4676258.10,7269970.00,3336455.00,7875210.00;1021,1724135.00,1313789.00,1816763.00,1630639.00,4678073.10,7298967.00,3336455.00,7875210.00;1022,1724135.00,1313789.00,1816763.00,1630639.00,4705219.10,7405678.00,3336455.00,8019950.00;1023,1724135.00,1313789.00,1816763.00,1630639.00,4822804.10,7427374.00,3336455.00,8092270.00;1024,1724135.00,1313789.00,1816763.00,1630639.00,4851732.10,7470746.00,3336455.00,8249580.00;1025,1724135.00,1313789.00,1816763.00,1630639.00,5075800.10,7653247.00,3336455.00,8442785.00;1026,1724135.00,1313789.00,1816763.00,1630639.00,5247303.10,7795803.00,3336455.00,8664804.00;1027,1724135.00,1313789.00,1816763.00,1912063.00,5350182.10,7855335.00,3386995.00,8664804.00;1028,1724135.00,1313789.00,1816763.00,2339257.00,5498161.10,7911250.00,3386995.00,8845104.00;1029,1724135.00,2213808.00,1816763.00,2789507.00,5669250.10,8127309.00,3450065.00,8989104.00;1030,2533016.00,2213808.00,1816763.00,2789507.00,5795302.10,8247949.00,3450065.00,9149194.00;1031,2533016.00,2213808.00,1816763.00,2789507.00,5820568.10,8287621.00,3450065.00,9149194.00;1032,2533016.00,2213808.00,1816763.00,2789507.00,5901917.10,8314735.00,3450065.00,9149194.00;1033,2533016.00,2726980.00,1816763.00,2789507.00,5974117.10,8327349.00,3450065.00,9279086.00;1034,2533016.00,2726980.00,1816763.00,2789507.00,6055198.10,8390378.00,3450065.00,9455493.00;1035,2533016.00,2726980.00,1816763.00,2789507.00,6114622.10,8464162.00,3639201.00,9867660.00;1036,2533016.00,2726980.00,1816763.00,2789507.00,6235392.10,8510973.00,3693261.00,9957690.00;1037,2533016.00,2726980.00,1816763.00,2789507.00,6287659.10,8536227.00,3819487.00,10092782.00;1038,2533016.00,2726980.00,1816763.00,2789507.00,6393964.10,8597527.00,3819487.00,10157582.00;1039,2533016.00,2726980.00,1816763.00,2789507.00,6466108.10,8712824.00,3878986.00,10247632.00;1040,2533016.00,2726980.00,1816763.00,2789507.00,6493183.10,8739839.00,4061291.00,10346742.00;1041,2533016.00,2726980.00,1816763.00,2789507.00,6563594.10,8759661.00,4234633.00,10436842.00;1042,2533016.00,2726980.00,1816763.00,2789507.00,6681165.10,8860914.00,4341308.00,10436842.00;1043,2533016.00,2726980.00,1816763.00,2789507.00,6717317.10,8893439.00,4451628.00,10436842.00;1044,2533016.00,2726980.00,1816763.00,2789507.00,6842126.10,8985663.00,4643260.00,10436842.00;1045,2533016.00,2726980.00,2178901.00,3198617.00,6871133.10,9125348.00,4753740.00,10496737.00;1046,2533016.00,2726980.00,2178901.00,3198617.00,6979984.10,9125348.00,4753740.00,10496737.00;1047,2533016.00,2726980.00,2178901.00,3198617.00,7065136.10,9143448.00,4753740.00,10496737.00","dotsCount":242}})'    #print(content)    if content is None:        time.sleep(random.uniform(62, 65))        continue    arr = content.split('last(')    json_content = arr[1].strip(')')    json_content = json.loads(json_content)    all = json_content[key]    money_data_arr = all['data'].split(';')    #处理两组数据    k = 0    sql = 'insert into tan_stock_record values '    for one_point in data_arr:        info = one_point.split(',')        time_point = int(info[0])        price = float(info[1])        zdf = round((price-pre)/pre*100,2)        volume = int(info[4])        price = price        volume = volume        time_point = time_point        date = today        try:            money_info = money_data_arr[k].split(',')        except Exception as e:            continue            pass       #print(money_info)        p1 = money_info[1]        p2 = money_info[2]        p3 = money_info[3]        p4 = money_info[4]        p5 = money_info[5]        p6 = money_info[6]        p7 = money_info[7]        p8 = money_info[8]        if(k==0):            sql_str = '(null,"%s","%s",%s,%s,"%s",%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)'%(name,sid,price,time_point,date,zdf,pre,volume,p1,p2,p3,p4,p5,p6,p7,p8)        else:            sql_str = ',(null,"%s","%s",%s,%s,"%s",%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)'%(name, sid, price, time_point, date, zdf, pre, volume, p1, p2, p3, p4, p5, p6, p7, p8)        sql += sql_str        k +=1    stock_helper.insertStockRecord(sql)    #标记这只股票今天更新    up_sql = "update tan_stock set date='%s' where sid='%s'"%(today,sid)    print(up_sql)    stock_helper.updateStock(up_sql)    time.sleep(random.uniform(62, 65))